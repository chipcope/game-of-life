/*
 * Medieval Blackletter Bubble Font for 64x64 RGB LED Matrix.
 *
 * Each character is 14px wide x 20px tall, displayed in a 16px cell (2px gap).
 * Last word = 4 chars x 16px = 64px (fills panel width exactly).
 *
 * Style: Gothic blackletter with pointed serifs, diamond dot on 'i',
 * thick-thin stroke contrast, hand-hewn character.
 */

#ifndef BUBBLE_FONT_H
#define BUBBLE_FONT_H

#include <cstdint>
#include <cstring>
#include <string>
#include <vector>

static const int CHAR_WIDTH = 14;
static const int CHAR_HEIGHT = 20;
static const int CELL_WIDTH = 16;

// Each glyph is 20 rows of 14 characters: '#' = on, '.' = off
struct Glyph {
    const char *rows[20];
};

// clang-format off
static const Glyph GLYPH_A = {{
    "......##......",
    ".....####.....",
    "....######....",
    "...###..###...",
    "...###..###...",
    "..###....###..",
    "..###....###..",
    ".###......###.",
    ".###......###.",
    ".############.",
    ".############.",
    "###........###",
    "###........###",
    "###........###",
    "###........###",
    "###........###",
    "###........###",
    "####......####",
    ".###......###.",
    "..##......##..",
}};

static const Glyph GLYPH_D = {{
    ".##...........",
    "####..........",
    "##########....",
    "############..",
    "####.....####.",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####.....####.",
    "############..",
    "##########....",
    "####..........",
    ".##...........",
}};

static const Glyph GLYPH_E = {{
    "..############",
    ".#############",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".##########...",
    ".##########...",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".#############",
    "##############",
    "######........",
    "..##..........",
}};

static const Glyph GLYPH_F = {{
    "..############",
    ".#############",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".##########...",
    ".##########...",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    ".####.........",
    "######........",
    "######........",
    "..##..........",
}};

static const Glyph GLYPH_G = {{
    "....########..",
    "..###########.",
    ".####.....####",
    ".####.....####",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####...#######",
    "####...#######",
    "####......####",
    "####......####",
    "####......####",
    ".####.....####",
    ".####.....####",
    "..###########.",
    "...#########..",
    "........####..",
    ".........##...",
}};

static const Glyph GLYPH_H = {{
    ".##........##.",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "##############",
    "##############",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "#####....#####",
    ".####....####.",
    "..##......##..",
}};

static const Glyph GLYPH_I = {{
    ".....##.......",
    "....####......",
    ".....##.......",
    "..............",
    "..#########...",
    "..#########...",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    "..#########...",
    "..#########...",
    "......##......",
}};

static const Glyph GLYPH_L = {{
    ".##...........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    ".#############",
    "##############",
    "######........",
    "..##..........",
}};

static const Glyph GLYPH_N = {{
    ".##........##.",
    "####......####",
    "#####.....####",
    "######....####",
    "##.####...####",
    "##..####..####",
    "##...####.####",
    "##....########",
    "##.....#######",
    "##......######",
    "##.......#####",
    "##........####",
    "##........####",
    "##........####",
    "##........####",
    "##........####",
    "###......#####",
    "####....######",
    ".###.....####.",
    "..##......##..",
}};

static const Glyph GLYPH_O = {{
    "....######....",
    "..##########..",
    ".####....####.",
    ".####....####.",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    ".####....####.",
    ".####....####.",
    "..##########..",
    "....######....",
    "..............",
}};

static const Glyph GLYPH_P = {{
    ".##...........",
    "####..........",
    "############..",
    "#############.",
    "####......####",
    "####......####",
    "####......####",
    "#############.",
    "############..",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "####..........",
    "######........",
    "######........",
    "..##..........",
}};

static const Glyph GLYPH_R = {{
    ".##...........",
    "####..........",
    "############..",
    "#############.",
    "####......####",
    "####......####",
    "####......####",
    "#############.",
    "############..",
    "####.####.....",
    "####..####....",
    "####...####...",
    "####....####..",
    "####.....####.",
    "####......####",
    "####......####",
    "####......####",
    "#####....#####",
    ".####....####.",
    "..##......##..",
}};

static const Glyph GLYPH_S = {{
    "...##########.",
    "..###########.",
    ".####.........",
    ".####.........",
    ".####.........",
    "..####........",
    "...######.....",
    ".....######...",
    ".......####...",
    "........####..",
    "........####..",
    "........####..",
    "........####..",
    "........####..",
    ".......####...",
    "......####....",
    ".############.",
    "############..",
    "####..........",
    ".##...........",
}};

static const Glyph GLYPH_T = {{
    "##############",
    "##############",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    ".....####.....",
    "....######....",
    "....######....",
    "......##......",
}};

static const Glyph GLYPH_U = {{
    ".##........##.",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    "####......####",
    ".####....####.",
    ".####....####.",
    "..##########..",
    "....######....",
    "..............",
}};

static const Glyph GLYPH_W = {{
    "##..........##",
    "##..........##",
    "##..........##",
    "##..........##",
    "##..........##",
    "##....##....##",
    "##...####...##",
    "##...####...##",
    "###..####..###",
    "###.######.###",
    "###.######.###",
    "####.####.####",
    "####.####.####",
    "####..##..####",
    ".####....####.",
    ".####....####.",
    "..###....###..",
    "..###....###..",
    "...##....##...",
    "....#....#....",
}};

static const Glyph GLYPH_SPACE = {{
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
    "..............",
}};
// clang-format on

static const Glyph *get_glyph(char c) {
    switch (c >= 'A' && c <= 'Z' ? c + 32 : c) {
        case 'a': return &GLYPH_A;
        case 'd': return &GLYPH_D;
        case 'e': return &GLYPH_E;
        case 'f': return &GLYPH_F;
        case 'g': return &GLYPH_G;
        case 'h': return &GLYPH_H;
        case 'i': return &GLYPH_I;
        case 'l': return &GLYPH_L;
        case 'n': return &GLYPH_N;
        case 'o': return &GLYPH_O;
        case 'p': return &GLYPH_P;
        case 'r': return &GLYPH_R;
        case 's': return &GLYPH_S;
        case 't': return &GLYPH_T;
        case 'u': return &GLYPH_U;
        case 'w': return &GLYPH_W;
        default:  return &GLYPH_SPACE;
    }
}

// Returns a bitmap: vector of rows, each row is a vector of 0/1
static std::vector<std::vector<uint8_t>> text_to_bitmap(const std::string &text) {
    std::vector<std::vector<uint8_t>> bitmap(CHAR_HEIGHT);
    for (int row = 0; row < CHAR_HEIGHT; row++) {
        for (size_t ci = 0; ci < text.size(); ci++) {
            const Glyph *g = get_glyph(text[ci]);
            const char *glyph_row = g->rows[row];
            for (int px = 0; px < CHAR_WIDTH; px++) {
                bitmap[row].push_back(glyph_row[px] == '#' ? 1 : 0);
            }
            // 2px gap between chars
            bitmap[row].push_back(0);
            bitmap[row].push_back(0);
        }
    }
    return bitmap;
}

// Place bitmap onto a grid (rows x cols) at given offset
static void bitmap_to_grid(const std::vector<std::vector<uint8_t>> &bitmap,
                            uint8_t *grid, int grid_w, int grid_h,
                            int x_off, int y_off) {
    memset(grid, 0, grid_w * grid_h);
    for (int row = 0; row < (int)bitmap.size(); row++) {
        int gy = y_off + row;
        if (gy < 0 || gy >= grid_h) continue;
        for (int col = 0; col < (int)bitmap[row].size(); col++) {
            int gx = x_off + col;
            if (gx < 0 || gx >= grid_w) continue;
            grid[gy * grid_w + gx] = bitmap[row][col];
        }
    }
}

// Overlay bitmap onto existing grid (OR operation â€” never clears cells)
static void overlay_bitmap_to_grid(const std::vector<std::vector<uint8_t>> &bitmap,
                                    uint8_t *grid, int grid_w, int grid_h,
                                    int x_off, int y_off) {
    for (int row = 0; row < (int)bitmap.size(); row++) {
        int gy = y_off + row;
        if (gy < 0 || gy >= grid_h) continue;
        for (int col = 0; col < (int)bitmap[row].size(); col++) {
            int gx = x_off + col;
            if (gx < 0 || gx >= grid_w) continue;
            if (bitmap[row][col])
                grid[gy * grid_w + gx] = 1;
        }
    }
}

#endif  // BUBBLE_FONT_H
