"""
Medieval / Blackletter bubble font for 64x64 RGB LED Matrix.

Each character is 14px wide x 20px tall, displayed in a 16px cell (2px gap).
Designed so the last word fills the full 64px panel width.

Style: Gothic blackletter with pointed serifs, diamond dots,
thick-thin stroke contrast, and hand-hewn character.
"""

CHAR_WIDTH = 14
CHAR_HEIGHT = 20
CELL_WIDTH = 16

GLYPHS = {}

GLYPHS['a'] = [
    '......##......',
    '.....####.....',
    '....######....',
    '...###..###...',
    '...###..###...',
    '..###....###..',
    '..###....###..',
    '.###......###.',
    '.###......###.',
    '.############.',
    '.############.',
    '###........###',
    '###........###',
    '###........###',
    '###........###',
    '###........###',
    '###........###',
    '####......####',
    '.###......###.',
    '..##......##..',
]

GLYPHS['d'] = [
    '.##...........',
    '####..........',
    '##########....',
    '############..',
    '####.....####.',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####.....####.',
    '############..',
    '##########....',
    '####..........',
    '.##...........',
]

GLYPHS['e'] = [
    '..############',
    '.#############',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.##########...',
    '.##########...',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.#############',
    '##############',
    '######........',
    '..##..........',
]

GLYPHS['f'] = [
    '..############',
    '.#############',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.##########...',
    '.##########...',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '.####.........',
    '######........',
    '######........',
    '..##..........',
]

GLYPHS['g'] = [
    '....########..',
    '..###########.',
    '.####.....####',
    '.####.....####',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####...#######',
    '####...#######',
    '####......####',
    '####......####',
    '####......####',
    '.####.....####',
    '.####.....####',
    '..###########.',
    '...#########..',
    '........####..',
    '.........##...',
]

GLYPHS['h'] = [
    '.##........##.',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '##############',
    '##############',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '#####....#####',
    '.####....####.',
    '..##......##..',
]

GLYPHS['i'] = [
    '.....##.......',
    '....####......',
    '.....##.......',
    '..............',
    '..#########...',
    '..#########...',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '..#########...',
    '..#########...',
    '......##......',
]

GLYPHS['l'] = [
    '.##...........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '.#############',
    '##############',
    '######........',
    '..##..........',
]

GLYPHS['n'] = [
    '.##........##.',
    '####......####',
    '#####.....####',
    '######....####',
    '##.####...####',
    '##..####..####',
    '##...####.####',
    '##....########',
    '##.....#######',
    '##......######',
    '##.......#####',
    '##........####',
    '##........####',
    '##........####',
    '##........####',
    '##........####',
    '###......#####',
    '####....######',
    '.###.....####.',
    '..##......##..',
]

GLYPHS['o'] = [
    '....######....',
    '..##########..',
    '.####....####.',
    '.####....####.',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '.####....####.',
    '.####....####.',
    '..##########..',
    '....######....',
    '..............',
]

GLYPHS['p'] = [
    '.##...........',
    '####..........',
    '############..',
    '#############.',
    '####......####',
    '####......####',
    '####......####',
    '#############.',
    '############..',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '####..........',
    '######........',
    '######........',
    '..##..........',
]

GLYPHS['r'] = [
    '.##...........',
    '####..........',
    '############..',
    '#############.',
    '####......####',
    '####......####',
    '####......####',
    '#############.',
    '############..',
    '####.####.....',
    '####..####....',
    '####...####...',
    '####....####..',
    '####.....####.',
    '####......####',
    '####......####',
    '####......####',
    '#####....#####',
    '.####....####.',
    '..##......##..',
]

GLYPHS['s'] = [
    '...##########.',
    '..###########.',
    '.####.........',
    '.####.........',
    '.####.........',
    '..####........',
    '...######.....',
    '.....######...',
    '.......####...',
    '........####..',
    '........####..',
    '........####..',
    '........####..',
    '........####..',
    '.......####...',
    '......####....',
    '.############.',
    '############..',
    '####..........',
    '.##...........',
]

GLYPHS['t'] = [
    '##############',
    '##############',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '.....####.....',
    '....######....',
    '....######....',
    '......##......',
]

GLYPHS['u'] = [
    '.##........##.',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '####......####',
    '.####....####.',
    '.####....####.',
    '..##########..',
    '....######....',
    '..............',
]

GLYPHS['w'] = [
    '##..........##',
    '##..........##',
    '##..........##',
    '##..........##',
    '##..........##',
    '##....##....##',
    '##...####...##',
    '##...####...##',
    '###..####..###',
    '###.######.###',
    '###.######.###',
    '####.####.####',
    '####.####.####',
    '####..##..####',
    '.####....####.',
    '.####....####.',
    '..###....###..',
    '..###....###..',
    '...##....##...',
    '....#....#....',
]

GLYPHS[' '] = [
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
    '..............',
]


def get_glyph(char):
    return GLYPHS.get(char.lower(), GLYPHS[' '])


def text_to_bitmap(text):
    if not text:
        return [[0] * CELL_WIDTH for _ in range(CHAR_HEIGHT)]
    bitmap = []
    for row in range(CHAR_HEIGHT):
        row_pixels = []
        for char in text:
            glyph = get_glyph(char)
            glyph_row = glyph[row] if row < len(glyph) else '.' * CHAR_WIDTH
            for px in glyph_row:
                row_pixels.append(1 if px == '#' else 0)
            row_pixels.extend([0, 0])
        bitmap.append(row_pixels)
    return bitmap


def bitmap_to_grid(bitmap, grid_width, grid_height, x_offset=0, y_offset=0):
    grid = [[0] * grid_width for _ in range(grid_height)]
    for row in range(len(bitmap)):
        gy = y_offset + row
        if gy < 0 or gy >= grid_height:
            continue
        for col in range(len(bitmap[row])):
            gx = x_offset + col
            if gx < 0 or gx >= grid_width:
                continue
            grid[gy][gx] = bitmap[row][col]
    return grid


def overlay_bitmap_to_grid(bitmap, grid, x_offset=0, y_offset=0):
    """Overlay bitmap onto existing grid (OR operation â€” never clears cells)."""
    grid_height = len(grid)
    grid_width = len(grid[0]) if grid else 0
    for row in range(len(bitmap)):
        gy = y_offset + row
        if gy < 0 or gy >= grid_height:
            continue
        for col in range(len(bitmap[row])):
            gx = x_offset + col
            if gx < 0 or gx >= grid_width:
                continue
            if bitmap[row][col]:
                grid[gy][gx] = 1
